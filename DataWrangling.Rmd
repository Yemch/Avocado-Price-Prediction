---
title: "Data Wrangling"
output: html_document
---

# 0. Project Overview and Motivation

The US demand for avocados has increased substantially since the 1980s (Carman HF, 2018). As a healthy superfood, avocados can be easily incorporated into several meals to meet requirements for daily intake of fiber, potassium, and monounsaturated fatty acids (Carman HF, 2018). If high demand for avocados leads to more competitive pricing, individuals in certain areas may not be able to incorporate avocados into their diets. We propose a US county-level descriptive analysis of avocado prices in comparison with food environment characteristics. 
We will also use these and related variables to predict avocado prices in California, a large US state with a diverse range of food environments. Our goal is to use this algorithm to predict avocado prices in other regions of the US to (1) provide context for area-specific food choices and (2) offer information on locations where avocados may be more reasonably priced.

Our project will :

- describe avocado prices and volumes across different counties of the US and the changes over time.

- predict avocado prices using predictors such as race percentage, income level, access and proximity to grocery store, and food purchasing assistance at the county level in California.

References:

Carman HF. (2018). The story behind avocadosâ€™ rise to prominence in the United States. Giannini Foundation of Agricultural Economics, University of California. Accessed 11/01/2020 at https://s.giannini.ucop.edu/uploads/giannini_public/5c/1f/5c1fa9d0-c5c9-45ce-8606-149ddf4f7397/v22n5_3.pdf.

US Department of Agriculture. (2020). US avocado demand is climbing steadily. Accessed 11/01/2020 at https://www.ers.usda.gov/data-products/chart-gallery/gallery/chart-detail/?chartId=98071.

---------------------

This Rmd is for the data wrangling process. We first cleaned the `avocado.csv` with unclear region descriptions and restricted the data only at city level. Since avocado prices data is mainly at city level and the Food Environment Atlas datasets are at county level, we created a new dataset `Cities-Counties-States.xlsx` mannualy for linking the cities to counties. After that, we merged prices data and food environment data together by the same county in the same state. Finally, a cleaned version of data is outputed as `avocado_clean.csv`.


```{r}
library(tidyverse)
library(readxl)
library(purrr)
```

# 1. Avocado Prices Data Cleaning
Historical data on avocado prices and sales volume in multiple US markets.
This data contains the outcome - the average price of a single avocado. The prices are summerised at city-level.
Source: https://www.kaggle.com/neuromusic/avocado-prices

Some relevant columns in the dataset:

Date - The date of the observation
AveragePrice - the average price of a single avocado
type - conventional or organic
year - the year
Region - the city or region of the observation
Total Volume - Total number of avocados sold
4046 - Total number of avocados with PLU 4046 sold
4225 - Total number of avocados with PLU 4225 sold
4770 - Total number of avocados with PLU 4770 sold

```{r}
avocado = read.csv("./avocado.csv") # avocado price data
city2county = read_xlsx("./Cities-Counties-States.xlsx") # city to county mapping data
head(avocado)
```

```{r}
summary(avocado)
```

Keep data with regions at city-level. For regions of combination of two cities such as "BaltimoreWashington", we exclude if two cities have distance greater than 30 miles, because we assume that cities with equal or closer distance of 30 miles have the same avocado prices.
```{r}
# Check all the combined cities left
city2county %>% 
  filter(Include == 1) %>%
  filter(!is.na(County2)) 

# Make a new dataset with separate cities
com = data.frame(Location = c("Hartford","Springfield","Miami","Fort Lauderdale"),
                 County1= c("HARTFORD","HAMPDEN","MIAMI-DADE","BROWARD"),
                 County2= NA,
                 Distance = NA,
                 State = c("CONNECTICUT","MASSACHUSETTS","FLORIDA","FLORIDA"))
com

# Drop not useful regions broader than city level (set Include == 1)
# Remove the rows with combination cities
# Add cities back separately
# remove unuseful columns
city2county = city2county %>%
  filter(Include == 1) %>%
  filter(Location != "HartfordSpringfield") %>%
  filter(Location != "MiamiFtLauderdale") %>%
  bind_rows(com) %>%
  dplyr::select(-County2,-Distance)

# Combine price dataset and county data together
avocado = avocado %>% 
  left_join(city2county, by = c("region" = "Location")) %>%
  filter(Include == 1) %>%
  dplyr::select(-X,-Include) # remove the first column

```

# 2. Food Environment Atlas Data Cleaning

These data are the potential predictors we will be used to predict avocado prices.

Read food environment atlas data. 
```{r}
county = read_xlsx("./FoodAtlasData/County.xlsx")
state = read_xlsx("./FoodAtlasData/State.xlsx")
access = read_xlsx("./FoodAtlasData/Access.xlsx")
stores = read_xlsx("./FoodAtlasData/Stores.xlsx")
restaurants = read_xlsx("./FoodAtlasData/Restaurants.xlsx")
assistance = read_xlsx("./FoodAtlasData/Assistance.xlsx")
insecurity = read_xlsx("./FoodAtlasData/Insecurity.xlsx")
taxes = read_xlsx("./FoodAtlasData/Taxes.xlsx")
local = read_xlsx("./FoodAtlasData/Local.xlsx")
health = read_xlsx("./FoodAtlasData/Health.xlsx")
socioecon = read_xlsx("./FoodAtlasData/SocioEconomic.xlsx")

# remove the last row in local dataset, which is an NA row 
local = local[1:nrow(local)-1,]
```

Merge all food environment atlas data together except for state population
```{r}
# Combine food environment atlas covariates together (county-level)
foodatlas = 
  # Place all tables at county-level into a list
  list(county, access, stores, restaurants, assistance, insecurity, taxes, local, health, socioecon) %>% 
  # Use reduce to join together the contents of the list
  reduce(left_join, by = "FIPS")

# Uncomment this line to check number of NA in each column
# apply(foodatlas, 2, function(x){sum(is.na(x))})

# remove duplicate columns
foodatlas = foodatlas %>% 
  dplyr::select(-State.x.x, -State.x.x.x, -State.x.x.x.x, -State.x.x.x.x.x, -State.y, -State.y.y, -State.y.y.y, -State.y.y.y.y, -State.y.y.y.y.y,
                -County.x.x, -County.x.x.x, -County.x.x.x.x, -County.x.x.x.x.x, -County.x, -County.y.y, -County.y.y.y, -County.y.y.y.y, -County.y.y.y.y.y)
```

# 3. Merge two parts together
```{r}
# Capitalize all the Counties and States in food environment atlas data
foodatlas$State.x = toupper(foodatlas$State.x)
foodatlas$County.y = toupper(foodatlas$County.y)

avocado = avocado %>%
  left_join(foodatlas, by = c("County1" = "County.y", "State" = "State.x"))

avocado = rename(avocado, County = County1)
avocado$County = tolower(avocado$County)
dim(avocado)
```

```{r}
write.csv(avocado,"./avocado_clean.csv", row.names = F)
```






